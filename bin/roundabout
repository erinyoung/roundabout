#!/usr/bin/env bash

VERSION="0.1.20220830"

USAGE="""
roundabout is for annotating complete plasmids and determining sections of identity to other similar plasmids.

This bash script is kept for sentimental reasons.

Usage:

roundabout -d <directory of plasmids>

Options:
-d : (required) <directory of plasmids>
-m : singularity (default) or docker
-o : output directory (default : roundabout)
-c : (optional) specify config file
-v : print version and exit
-t : use tower (default : off)
-r : do not resume (default : resume)
-n : other nextflow options
"""

echo "$(date) : starting roundabout "

roundaboutpath=$(which $0 | sed 's/bin\/roundabout//g')
manager='singularity'
out='roundabout'
config=""
tower=""
resume="-resume"
nextflow_options=""
directory=""

while getopts "hvd:o:m:trn:" opt
do
  case ${opt} in
    h )
      echo "$USAGE"
      exit 0
      ;;
    d )
      if [ -d "$OPTARG" ]
      then
        directory=$OPTARG
        echo "$(date) : directory with plasmids is $directory"
      else
        "$(date) : FATAL : directory with fastas does not exist. Set with '-d'"
        exit 1 
      fi
      ;;
    o )
      out=$OPTARG
      echo "$(date) : final files will be saved in $out"
      ;;
    v )
      echo "roundabout v.$VERSION"
      exit 0
      ;;
    m )
      if [ "$OPTARG" == "singularity" ]
      then
        manager=singularity
      elif [ "$OPTARG" == "docker" ]
      then
        manager=docker
      else
        echo "$(date) : FATAL : container manager not recognized. Must be 'singularity' or 'docker'"
        exit 1
      fi
      ;;
    c )
      if [ -f "$OPTARG" ]
      then
        config_file="-c $OPTARG"
        echo "$(date) : additional config file found : $config_file"
      else 
        echo "$(date) : FATAL : config file does not exist!"
        exit 1
      fi
      ;;
      t )
        echo "$(date) : using nextflow tower"
        tower="-with-tower"
      ;;
      r )
        echo "$(date) : will not resume"
        resume=""
      ;;
      n )
        echo "$(date) : adding additonal nextflow options : $OPTARG"
        nextflow_options="$OPTARG"
      ;;
    \? )
      echo "$USAGE"
      exit 1
      ;;
  esac
done
shift $((OPTIND -1))

if [ -z "$(which nextflow)" ] ; then echo "$(date): FATAL : nextflow was not found" ; exit 1 ; fi
if [ -z "$(which $manager)" ] ; then echo "$(date): FATAL : container manager not found" ; exit 1 ; fi

if [ ! -d "$directory" ]
then
  "$(date) : FATAL : directory with fastas does not exist. Set with '-d'"
  echo "$USAGE"
  exit 1 
fi

echo "$(date) : starting workflow"
nextflow run $roundaboutpath/nextflow \
  -profile $manager \
  --outdir $out \
  $config_file \
  --plasmid_directory $directory \
  $tower \
  $resume \
  $nextflow_options

echo "$(date) : workflow has been completed"